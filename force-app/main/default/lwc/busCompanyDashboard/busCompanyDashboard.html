<template>
    <lightning-card title="Bus Company Dashboard" icon-name="custom:custom63">
        
        <div slot="actions">
            <lightning-button 
                label="Refresh" 
                onclick={refreshData}
                icon-name="utility:refresh"
                variant="brand">
            </lightning-button>
        </div>

        <div class="slds-m-around_medium">
            
            <!-- Loading Spinner -->
            <template if:true={isLoading}>
                <lightning-spinner 
                    alternative-text="Loading buses..."
                    size="medium">
                </lightning-spinner>
            </template>

            <!-- Error Message -->
            <template if:true={error}>
                <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error" 
                     role="alert">
                    <span class="slds-assistive-text">Error</span>
                    <lightning-icon 
                        icon-name="utility:error" 
                        size="x-small" 
                        alternative-text="Error"
                        class="slds-m-right_x-small">
                    </lightning-icon>
                    <h2>{error}</h2>
                </div>
            </template>

            <!-- Company Info -->
            <template if:true={companyData}>
                <div class="slds-box slds-theme_default slds-m-bottom_medium">
                    <h2 class="slds-text-heading_medium slds-m-bottom_small">
                        {companyData.Name}
                    </h2>
                    <p class="slds-text-body_regular">
                        <strong>Company Name:</strong> {companyData.fields.Name.value}
                    </p>
                    <template if:true={companyData.Address__c}>
                        <p class="slds-text-body_regular">
                            <strong>Address:</strong> {companyData.Address__c}
                        </p>
                    </template>
                </div>
            </template>

            <!-- Buses List -->
            <template if:true={hasBuses}>
                <h3 class="slds-text-heading_small slds-m-bottom_medium">
                    Buses ({buses.length})
                </h3>
                
                <div class="slds-grid slds-wrap slds-gutters">
                    <template for:each={buses} for:item="bus">
                        <div key={bus.Id} class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-large-size_1-of-3">
                            <article class="slds-card article">
                                <div class="slds-card__header slds-grid">
                                    <header class="slds-media slds-media_center slds-has-flexi-truncate">
                                        <div class="slds-media__figure" data-bus-icon></div>
                                        <div class="slds-media__body">
                                            <h2 class="slds-card__header-title">
                                                <span class="slds-text-heading_small">{bus.Name}</span>
                                            </h2>
                                        </div>
                                        <div class="slds-no-flex" data-status={bus.Bus_Status__c} >
                                      
                                        </div>
                                    </header>
                                </div>
                                
                                <div class="slds-card__body slds-card__body_inner">
                                    <p class="slds-text-body_regular slds-m-bottom_small">
                                        <strong>Passengers:</strong> {bus.passengerCount} / 20
                                    </p>
                                    
                                    <!-- Progress Bar -->
                                    <div class="slds-progress-bar slds-progress-bar_x-small slds-m-bottom_small">
                                        <span class="slds-progress-bar__value" style={bus.progressStyle}>
                                            <span class="slds-assistive-text">
                                                Progress: {bus.occupancyPercentage}%
                                            </span>
                                        </span>
                                    </div>
                                    
                                    <!-- Passenger List (Collapsible) -->
                                    <template if:true={bus.hasPassengers}>
                                        <div class="slds-m-top_small">
                                            <button 
                                                class="slds-button slds-button_stretch"
                                                onclick={togglePassengerList}
                                                data-bus-id={bus.Id}>
                                                <lightning-icon 
                                                    icon-name={bus.passengerListIcon}
                                                    size="x-small"
                                                    class="slds-m-right_x-small">
                                                </lightning-icon>
                                                {bus.passengerListLabel}
                                            </button>
                                            
                                            <template if:true={bus.showPassengers}>
                                                <div class="slds-box slds-box_x-small slds-theme_shade slds-m-top_x-small">
                                                    <ul class="slds-list_dotted">
                                                        <template for:each={bus.Passengers__r} for:item="passenger">
                                                            <li key={passenger.Id} class="slds-item">
                                                                {passenger.Name}
                                                                <template if:true={passenger.Email__c}>
                                                                    <span class="slds-text-body_small slds-text-color_weak">
                                                                        ({passenger.Email__c})
                                                                    </span>
                                                                </template>
                                                            </li>
                                                        </template>
                                                    </ul>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                    
                                    <template if:false={bus.hasPassengers}>
                                        <p class="slds-text-body_small slds-text-color_weak">
                                            No passengers assigned
                                        </p>
                                    </template>
                                </div>
                            </article>
                        </div>
                    </template>
                </div>
            </template>

            <!-- No Buses Message -->
            <template if:false={hasBuses}>
                <template if:false={isLoading}>
                    <div class="slds-illustration slds-illustration_small">
                        <div class="slds-text-longform">
                            <h3 class="slds-text-heading_medium">No buses found</h3>
                            <p class="slds-text-body_regular">
                                This bus company doesn't have any buses assigned yet.
                            </p>
                        </div>
                    </div>
                </template>
            </template>

        </div>
    </lightning-card>
</template>